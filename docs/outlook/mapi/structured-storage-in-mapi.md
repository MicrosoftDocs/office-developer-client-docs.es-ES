---
title: Almacenamiento estructurado en MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Última modificación: 09 de marzo de 2015'
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411753"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="f88ab-103">Almacenamiento estructurado en MAPI</span><span class="sxs-lookup"><span data-stu-id="f88ab-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="f88ab-104">**Se aplica a**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="f88ab-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="f88ab-105">El almacenamiento estructurado hace referencia a la organización jerárquica de almacenamiento introducida con COM.</span><span class="sxs-lookup"><span data-stu-id="f88ab-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="f88ab-106">En un entorno de almacenamiento estructurado, el almacenamiento se organiza en dos o tres tipos de objetos:</span><span class="sxs-lookup"><span data-stu-id="f88ab-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="f88ab-107">Objetos Stream</span><span class="sxs-lookup"><span data-stu-id="f88ab-107">Stream objects</span></span>
    
- <span data-ttu-id="f88ab-108">Bloquear objetos bytes</span><span class="sxs-lookup"><span data-stu-id="f88ab-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="f88ab-109">Objetos de almacenamiento</span><span class="sxs-lookup"><span data-stu-id="f88ab-109">Storage objects</span></span>
    
<span data-ttu-id="f88ab-110">Los bytes de secuencia y bloqueo son objetos de nivel inferior que tienen acceso directo a los datos.</span><span class="sxs-lookup"><span data-stu-id="f88ab-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="f88ab-111">Los objetos Stream implementan la **interfaz IStream** que define métodos para leer, escribir, colocar y copiar bytes de datos.</span><span class="sxs-lookup"><span data-stu-id="f88ab-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="f88ab-112">Los objetos de bytes de bloqueo implementan otra interfaz COM, **ILockBytes,** para tener acceso a los datos con una matriz de bytes.</span><span class="sxs-lookup"><span data-stu-id="f88ab-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="f88ab-113">Las matrices de bytes suelen usarse para proporcionar acceso personalizado al almacenamiento subyacente.</span><span class="sxs-lookup"><span data-stu-id="f88ab-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="f88ab-114">Los objetos de almacenamiento se encuentran en capas encima de los objetos stream o lock bytes; pueden contener uno o varios de estos objetos, así como otros objetos de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="f88ab-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="f88ab-115">Los objetos de almacenamiento implementan **la interfaz IStorage** que define métodos para crear, obtener acceso y mantener objetos anidados.</span><span class="sxs-lookup"><span data-stu-id="f88ab-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="f88ab-116">Dado **que IStream**, **ILockBytes** e **IStorage** son interfaces COM en lugar de interfaces MAPI, sus métodos devuelven valores de error COM en lugar de valores MAPI.</span><span class="sxs-lookup"><span data-stu-id="f88ab-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="f88ab-117">Los clientes y proveedores de servicios que llaman a métodos en estas interfaces deben usar la función DE API **MapStorageSCode** para traducir estos valores a valores de error MAPI.</span><span class="sxs-lookup"><span data-stu-id="f88ab-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="f88ab-118">Para obtener más información, [vea MapStorageSCode](mapstoragescode.md).</span><span class="sxs-lookup"><span data-stu-id="f88ab-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="f88ab-119">Los clientes y proveedores de servicios usan almacenamiento estructurado para trabajar con propiedades demasiado grandes para mantener con los métodos **IMAPIProp,** normalmente propiedades binarias y de cadena de gran tamaño.</span><span class="sxs-lookup"><span data-stu-id="f88ab-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="f88ab-120">Una de las maneras comunes en que los clientes o proveedores de servicios tienen acceso a ellos es especificando **IStream** o **IStorage** como identificador de interfaz en una llamada al método [IMAPIProp::OpenProperty.](imapiprop-openproperty.md)</span><span class="sxs-lookup"><span data-stu-id="f88ab-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="f88ab-121">Por ejemplo, los clientes llaman a **OpenProperty** con **PR_ATTACH_DATA_BIN** como etiqueta de propiedad y IID_IStream como identificador de interfaz para obtener acceso a datos adjuntos binarios en un mensaje.</span><span class="sxs-lookup"><span data-stu-id="f88ab-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="f88ab-122">Los clientes y proveedores de servicios pueden implementar sus propios objetos de flujo y almacenamiento o llamar a funciones api para obtener acceso a las implementaciones proporcionadas por MAPI o COM.</span><span class="sxs-lookup"><span data-stu-id="f88ab-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="f88ab-123">Dado que las implementaciones proporcionadas sirven para la mayoría de los propósitos, los clientes y proveedores de servicios rara vez necesitan crear sus propios.</span><span class="sxs-lookup"><span data-stu-id="f88ab-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="f88ab-124">Cuando un cliente llama a **OpenProperty** en un objeto MAPI para tener acceso a una de sus propiedades a través de un objeto de almacenamiento, el proveedor de servicios normalmente abrirá el objeto de almacenamiento en modo directo.</span><span class="sxs-lookup"><span data-stu-id="f88ab-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="f88ab-125">Sin embargo, esto es típico en lugar de un comportamiento obligatorio.</span><span class="sxs-lookup"><span data-stu-id="f88ab-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="f88ab-126">Los clientes deben suponer que todos los objetos de almacenamiento abiertos o creados por proveedores de servicios se transaccionan y requieren una llamada a **IStorage::Commit**.</span><span class="sxs-lookup"><span data-stu-id="f88ab-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="f88ab-127">También deben recordar que los cambios en los objetos de almacenamiento no se realizarán de forma permanente hasta que llamen a **IMAPIProp::SaveChanges** después de la confirmación **final** para guardar el objeto MAPI.</span><span class="sxs-lookup"><span data-stu-id="f88ab-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="f88ab-128">Para obtener más información, [vea IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="f88ab-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="f88ab-129">MAPI y COM proporcionan varias funciones api para definir o tener acceso a objetos de almacenamiento y secuencia.</span><span class="sxs-lookup"><span data-stu-id="f88ab-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="f88ab-130">Las funciones que se usan habitualmente se describen en la tabla siguiente.</span><span class="sxs-lookup"><span data-stu-id="f88ab-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="f88ab-131">**Funciones para obtener acceso a objetos de flujo y almacenamiento**</span><span class="sxs-lookup"><span data-stu-id="f88ab-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="f88ab-132">**Función**</span><span class="sxs-lookup"><span data-stu-id="f88ab-132">**Function**</span></span>|<span data-ttu-id="f88ab-133">**Descripción**</span><span class="sxs-lookup"><span data-stu-id="f88ab-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="f88ab-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="f88ab-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="f88ab-135">Crea un objeto de almacenamiento para tener acceso a un objeto stream o lock bytes.</span><span class="sxs-lookup"><span data-stu-id="f88ab-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="f88ab-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="f88ab-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="f88ab-137">Crea un objeto de mensaje para tener acceso a un objeto de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="f88ab-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="f88ab-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="f88ab-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="f88ab-139">Crea un objeto de secuencia para tener acceso a un archivo.</span><span class="sxs-lookup"><span data-stu-id="f88ab-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="f88ab-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="f88ab-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="f88ab-141">Crea un objeto de secuencia que contiene la versión comprimida o sin comprimir de una secuencia que contiene el texto enriquecido de un mensaje.</span><span class="sxs-lookup"><span data-stu-id="f88ab-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="f88ab-142">**Para recuperar los nombres de las secuencias en un substorage determinado**</span><span class="sxs-lookup"><span data-stu-id="f88ab-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="f88ab-143">Llama al método **IStorage::EnumElements** del substorage para obtener una **interfaz IEnumSTATSTG.**</span><span class="sxs-lookup"><span data-stu-id="f88ab-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="f88ab-144">Llama **a IEnumSTATSTG::Next** con tantas estructuras **STATSTG** a la vez como puedas.</span><span class="sxs-lookup"><span data-stu-id="f88ab-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="f88ab-145">Si pides 100 a la vez, **Next** normalmente devolverá S_FALSE con el contenido de  _pceltFetched_ establecido en el número que se recuperó realmente.</span><span class="sxs-lookup"><span data-stu-id="f88ab-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="f88ab-146">Comprueba las estructuras **STATSTG** que están marcadas con STGTY_STREAM.</span><span class="sxs-lookup"><span data-stu-id="f88ab-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="f88ab-147">Libere el _parámetro pwcsName._</span><span class="sxs-lookup"><span data-stu-id="f88ab-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="f88ab-148">**Para crear un objeto de almacenamiento para tener acceso a un objeto stream o lock bytes existente**</span><span class="sxs-lookup"><span data-stu-id="f88ab-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="f88ab-149">Los clientes [llaman a HrIStorageFromStream](hristoragefromstream.md).</span><span class="sxs-lookup"><span data-stu-id="f88ab-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="f88ab-150">**Para crear un objeto de mensaje para tener acceso a un objeto de almacenamiento existente**</span><span class="sxs-lookup"><span data-stu-id="f88ab-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="f88ab-151">Los proveedores de servicios y clientes [llaman a OpenIMsgOnIStg](openimsgonistg.md).</span><span class="sxs-lookup"><span data-stu-id="f88ab-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="f88ab-152">El objeto de mensaje que se crea difiere de los objetos de mensaje que normalmente crean los proveedores de al almacenamiento de mensajes en que no admite todos los métodos de interfaz [IMessage : IMAPIProp,](imessageimapiprop.md) como **IMessage::SubmitMessage**.</span><span class="sxs-lookup"><span data-stu-id="f88ab-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="f88ab-153">Un parámetro de entrada opcional para **OpenIMsgOnIStg** es una función de devolución de llamada que se ajusta al prototipo [MSGCALLRELEASE.](msgcallrelease.md)</span><span class="sxs-lookup"><span data-stu-id="f88ab-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="f88ab-154">El nuevo objeto de mensaje llama a esta función cuando el recuento de referencias del mensaje alcanza cero.</span><span class="sxs-lookup"><span data-stu-id="f88ab-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="f88ab-155">La implementación de **una función MSGCALLRELEASE** puede ser útil para realizar el procesamiento final antes de que el nuevo mensaje se quite por completo.</span><span class="sxs-lookup"><span data-stu-id="f88ab-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="f88ab-156">[OpenStreamOnFile](openstreamonfile.md) se usa normalmente para almacenar datos adjuntos de archivos porque crea una secuencia que lee y escribe en un archivo.</span><span class="sxs-lookup"><span data-stu-id="f88ab-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="f88ab-157">**OpenProperty** con **PR_ATTACH_DATA_BIN** etiqueta de propiedad crea una secuencia para almacenar datos adjuntos binarios.</span><span class="sxs-lookup"><span data-stu-id="f88ab-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="f88ab-158">**Para comprimir o descomprimir una secuencia que contiene texto del mensaje en el formato de texto enriquecido**</span><span class="sxs-lookup"><span data-stu-id="f88ab-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="f88ab-159">Los clientes [llaman a WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span><span class="sxs-lookup"><span data-stu-id="f88ab-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="f88ab-160">**WrapCompressedRTFStream** crea una secuencia que encapsula la secuencia RTF.</span><span class="sxs-lookup"><span data-stu-id="f88ab-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="f88ab-161">La secuencia contenedora no implementa todos los métodos **IStream;** Se excluyen los métodos siguientes: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat** y **Clone**.</span><span class="sxs-lookup"><span data-stu-id="f88ab-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="f88ab-162">Esto se debe a que los objetos de secuencia creados por **WrapCompressedRTFStream** no **admiten SetSize** o **Stat**, no hay una forma fácil de extender o recuperar su tamaño.</span><span class="sxs-lookup"><span data-stu-id="f88ab-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="f88ab-163">La mejor estrategia es elegir un tamaño de búfer razonable y leer o escribir en un bucle.</span><span class="sxs-lookup"><span data-stu-id="f88ab-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="f88ab-164">COM tiene una implementación de objeto de almacenamiento basada en una matriz de bytes que devuelve un objeto **IEnumSTATSTG** del método **EnumElements** que es problemático.</span><span class="sxs-lookup"><span data-stu-id="f88ab-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="f88ab-165">En particular, el **método QueryInterface** no funciona correctamente.</span><span class="sxs-lookup"><span data-stu-id="f88ab-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="f88ab-166">Los proveedores de servicios que implementan sus propios objetos de almacenamiento mediante la implementación COM deben crear un contenedor fino para el objeto **IEnumSTATSTG** que reenvía llamadas a los métodos **subyacentes de IEnumSTATSTG** pero implementa sus propios **métodos AddRef**, **Release**, **QueryInterface** y **Clone.**</span><span class="sxs-lookup"><span data-stu-id="f88ab-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

