---
title: Finalizar una sesión MAPI
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: ca153737-75dc-426a-a410-7a7ab3264f23
description: 'Última modificación: 23 de julio de 2011'
ms.openlocfilehash: 74c2a7247df02570761247a9e4a6fae378f37312
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 04/23/2019
ms.locfileid: "32287156"
---
# <a name="ending-a-mapi-session"></a><span data-ttu-id="29e66-103">Finalizar una sesión MAPI</span><span class="sxs-lookup"><span data-stu-id="29e66-103">Ending a MAPI Session</span></span>

  
  
<span data-ttu-id="29e66-104">**Se aplica a**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="29e66-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="29e66-105">Los clientes pueden finalizar sus sesiones en respuesta a la solicitud de un usuario, ya sea inmediatamente o después de que se hayan procesado todos los mensajes salientes, y cuando se produce un error crítico.</span><span class="sxs-lookup"><span data-stu-id="29e66-105">Clients can end their sessions in response to a user's request, either immediately or after all outbound messages have been processed, and when a critical error occurs.</span></span> <span data-ttu-id="29e66-106">Algunos clientes necesitan permanecer en sesión para que los mensajes salientes pendientes puedan llegar al proveedor de transporte y al sistema de mensajería de destino.</span><span class="sxs-lookup"><span data-stu-id="29e66-106">Some clients need to stay logged on so that pending outbound messages can reach the transport provider and the destination messaging system.</span></span> <span data-ttu-id="29e66-107">Si un cliente de este tipo envía un mensaje y cierra la sesión inmediatamente, el mensaje puede permanecer en la cola de salida hasta que un usuario vuelva a iniciar sesión y se mantenga registrado el tiempo suficiente para que se transmita el mensaje.</span><span class="sxs-lookup"><span data-stu-id="29e66-107">If such a client sends a message and immediately logs off, the message may remain in the outgoing queue until a user logs back on and stays logged on long enough for the message to be transmitted.</span></span>
  
 <span data-ttu-id="29e66-108">**Cuando necesite finalizar la sesión con el subsistema MAPI**</span><span class="sxs-lookup"><span data-stu-id="29e66-108">**When you need to terminate your session with the MAPI subsystem**</span></span>
  
1. <span data-ttu-id="29e66-109">Cancelar los registros de todas las notificaciones llamando al método **Unadvise** de cada objeto registrado.</span><span class="sxs-lookup"><span data-stu-id="29e66-109">Cancel the registrations for all notifications by calling the **Unadvise** method of every registered object.</span></span> 
    
2. <span data-ttu-id="29e66-110">Libere todos los objetos abiertos llamando a sus métodos [IUnknown:: Release](https://msdn.microsoft.com/library/ms682317%28VS.85%29.aspx) .</span><span class="sxs-lookup"><span data-stu-id="29e66-110">Release all open objects by calling their [IUnknown::Release](https://msdn.microsoft.com/library/ms682317%28VS.85%29.aspx) methods.</span></span> <span data-ttu-id="29e66-111">Los tipos de objetos abiertos pueden incluir receptores de notificaciones, la tabla de estado, la carpeta Bandeja de salida, uno o más almacenes de mensajes y la libreta de direcciones.</span><span class="sxs-lookup"><span data-stu-id="29e66-111">The types of open objects can include advise sinks, the status table, the Outbox folder, one or more message stores, and the address book.</span></span> 
    
3. <span data-ttu-id="29e66-112">Llamar a [MAPIFreeBuffer](mapifreebuffer.md) para liberar la memoria de los identificadores de entrada en caché, como **PR_IPM_SUBTREE_ENTRYID** ([PidTagIpmSubtreeEntryId](pidtagipmsubtreeentryid-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="29e66-112">Call [MAPIFreeBuffer](mapifreebuffer.md) to free the memory for any cached entry identifiers, such as **PR_IPM_SUBTREE_ENTRYID** ([PidTagIpmSubtreeEntryId](pidtagipmsubtreeentryid-canonical-property.md)).</span></span>
    
4. <span data-ttu-id="29e66-113">Llame a [IMAPISession:: Logoff](imapisession-logoff.md)y establezca la marca MAPI_LOGOFF_UI si permite una interfaz de usuario y la marca MAPI_LOGOFF_SHARED si es propietario de la sesión compartida actual.</span><span class="sxs-lookup"><span data-stu-id="29e66-113">Call [IMAPISession::Logoff](imapisession-logoff.md), setting the MAPI_LOGOFF_UI flag if you allow a user interface and the MAPI_LOGOFF_SHARED flag if you own the current shared session.</span></span> <span data-ttu-id="29e66-114">El **cierre** de sesión notifica a todos los demás clientes que usan la sesión compartida actual que deben cerrar la sesión mediante el envío de una notificación de error.</span><span class="sxs-lookup"><span data-stu-id="29e66-114">**Logoff** notifies all other clients that are using the current shared session that they should log off by sending an error notification.</span></span> 
    
5. <span data-ttu-id="29e66-115">Libere el puntero de sesión llamando al método **IUnknown:: Release** de la sesión.</span><span class="sxs-lookup"><span data-stu-id="29e66-115">Release the session pointer by calling the session's **IUnknown::Release** method.</span></span> 
    
6. <span data-ttu-id="29e66-116">Si llama a [OleInitialize](https://msdn.microsoft.com/library/ms690134%28v=VS.85%29.aspx) durante el inicio de la sesión para inicializar las bibliotecas OLE, debe desinicializarlas ahora llamando a [OleUninitialize](https://msdn.microsoft.com/library/ms691326%28VS.85%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="29e66-116">If you called [OleInitialize](https://msdn.microsoft.com/library/ms690134%28v=VS.85%29.aspx) during session startup to initialize the OLE libraries, uninitialize them now by calling [OleUninitialize](https://msdn.microsoft.com/library/ms691326%28VS.85%29.aspx).</span></span> <span data-ttu-id="29e66-117">Solo los clientes que han llamado a **OleInitialize** deben llamar a **OleUninitialize**.</span><span class="sxs-lookup"><span data-stu-id="29e66-117">Only clients that have called **OleInitialize** must call **OleUninitialize**.</span></span> 
    
7. <span data-ttu-id="29e66-118">Desinicialice las bibliotecas MAPI llamando a [MAPIUninitialize](mapiuninitialize.md).</span><span class="sxs-lookup"><span data-stu-id="29e66-118">Uninitialize the MAPI libraries by calling [MAPIUninitialize](mapiuninitialize.md).</span></span> <span data-ttu-id="29e66-119">Si llamó a **OleInitialize** en algún momento, asegúrese de que se produce una llamada a **OleUninitialize** antes de esta llamada a **MAPIUninitialize**.</span><span class="sxs-lookup"><span data-stu-id="29e66-119">If you called **OleInitialize** at some point, make sure that a call to **OleUninitialize** occurs before this call to **MAPIUninitialize**.</span></span> <span data-ttu-id="29e66-120">El tiempo es crucial.</span><span class="sxs-lookup"><span data-stu-id="29e66-120">The timing is crucial.</span></span> <span data-ttu-id="29e66-121">Si la llamada a **OleUninitialize** sigue la llamada a **MAPIUninitialize**, es posible que el cliente finalice de forma incorrecta.</span><span class="sxs-lookup"><span data-stu-id="29e66-121">If the call to **OleUninitialize** follows the call to **MAPIUninitialize**, your client might terminate ungracefully.</span></span> 
    
8. <span data-ttu-id="29e66-122">Si llamó a [ScInitMapiUtil](scinitmapiutil.md) durante el inicio de la sesión para inicializar la biblioteca de la utilidad MAPI, desinicialice ahora llamando a [DeinitMapiUtil](deinitmapiutil.md).</span><span class="sxs-lookup"><span data-stu-id="29e66-122">If you called [ScInitMapiUtil](scinitmapiutil.md) during session startup to initialize the MAPI utility library, uninitialize it now by calling [DeinitMapiUtil](deinitmapiutil.md).</span></span> <span data-ttu-id="29e66-123">Solo los clientes que han llamado a **ScInitMapiUtil** deben llamar a **DeinitMapiUtil**.</span><span class="sxs-lookup"><span data-stu-id="29e66-123">Only clients that have called **ScInitMapiUtil** must call **DeinitMapiUtil**.</span></span>
    
> [!NOTE]
> <span data-ttu-id="29e66-124">Todos los objetos abiertos deben liberarse antes de la llamada a **IMAPISession:: Logoff**.</span><span class="sxs-lookup"><span data-stu-id="29e66-124">All open objects must be released before the call to **IMAPISession::Logoff**.</span></span> <span data-ttu-id="29e66-125">Los objetos que permanecen abiertos después de **Cerrar sesión** dejan de ser válidos; no pueden aceptar ninguna llamada y es posible que nunca se liberen.</span><span class="sxs-lookup"><span data-stu-id="29e66-125">Objects that remain open after **Logoff** is called become invalid; they cannot accept any calls and might never be freed.</span></span> <span data-ttu-id="29e66-126">Si se realiza una llamada a uno de estos objetos, se espera que se produzca un error en la llamada.</span><span class="sxs-lookup"><span data-stu-id="29e66-126">If a call is made to one of these objects, expect the call to fail.</span></span> 
  
 <span data-ttu-id="29e66-127">MAPI no tiene ningún mecanismo para eliminar dll durante el proceso de cierre de sesión.</span><span class="sxs-lookup"><span data-stu-id="29e66-127">MAPI has no mechanism for deleting DLLs during the session shutdown process.</span></span> <span data-ttu-id="29e66-128">La DLL de un proveedor de servicios solo se puede eliminar cuando un cliente de configuración como el panel de control llama a su función de punto de entrada del servicio de mensajes con el evento MSG_SERVICE_INSTALL.</span><span class="sxs-lookup"><span data-stu-id="29e66-128">A service provider's DLL can only be deleted when a configuration client such as the Control Panel calls its message service entry point function with the MSG_SERVICE_INSTALL event.</span></span> 
  

