---
title: Env�o de mensajes Tareas de proveedor de almac�n de mensajes
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: acbfd3ae-bfdc-4103-bed2-6bcf7b9c448c
description: '�ltima modificaci�n: lunes, 9 de marzo de 2015'
ms.openlocfilehash: de29707c7a257ea0e7ad658622d2a3054487f8b5
ms.sourcegitcommit: adcf409d56b6cb25be6117f09794defa41ad6c0f
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/14/2019
ms.locfileid: "37495309"
---
# <a name="sending-messages-message-store-provider-tasks"></a><span data-ttu-id="ad6c1-103">Envío de mensajes: tareas del proveedor del almacén de mensajes</span><span class="sxs-lookup"><span data-stu-id="ad6c1-103">Sending Messages: Message Store Provider Tasks</span></span>

<span data-ttu-id="ad6c1-104">**Se aplica a**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="ad6c1-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="ad6c1-p101">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method. If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-p101">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method. If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span></span> 
  
<span data-ttu-id="ad6c1-p102">El proveedor de almacenamiento de mensajes determina si se debe o no relacionadas con la cola MAPI. Si no se complementa el proveedor de almacenamiento de mensajes, el mensaje requiere preprocesamiento, o el almac�n de acoplamiento ajustado y el transporte no pueden controlar todos los destinatarios, la cola MAPI debe estar involucrada.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-p102">The message store provider determines whether or not to involve the MAPI spooler. If the message store provider is not tightly coupled, the message requires preprocessing, or the tightly coupled store and transport cannot handle all of the recipients, the MAPI spooler must be involved.</span></span> 
  
<span data-ttu-id="ad6c1-109">El procedimiento siguiente describe las tareas necesarias de un proveedor de almac�n de mensajes para enviar un mensaje.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-109">The following procedure describes the tasks required of a message store provider for sending a message.</span></span> 
  
<span data-ttu-id="ad6c1-110">**En IMessage::SubmitMessage, el proveedor del almacén de mensajes:**</span><span class="sxs-lookup"><span data-stu-id="ad6c1-110">**In IMessage::SubmitMessage, the message store provider**:</span></span>
  
1. <span data-ttu-id="ad6c1-111">Llama a [IMAPISupport::P repareSubmit](imapisupport-preparesubmit.md) si el mensaje tiene la marca MSGFLAG_RESEND establecida en su propiedad **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) y devuelve los errores al cliente.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-111">Calls [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md) if the message has the MSGFLAG_RESEND flag set in its **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) property and returns any errors to the client.</span></span> <span data-ttu-id="ad6c1-112">**PrepareSubmit comprueba** la **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) de cada destinatario de la lista de destinatarios del mensaje.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-112">**PrepareSubmit** checks the **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) property of each recipient in the message's recipient list.</span></span>
    
   - <span data-ttu-id="ad6c1-113">Si se establece la marca MAPI_SUBMITTED, que indica que el destinatario no recibió el mensaje original, **PrepareSubmit** borra la marca y establece la propiedad **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) en TRUE.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-113">If the MAPI_SUBMITTED flag is set, indicating that the recipient did not receive the original message, **PrepareSubmit** clears the flag and sets the **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) property to TRUE.</span></span> 
    
   - <span data-ttu-id="ad6c1-114">Si no se establece la marca MAPI_SUBMITTED, que indica que el destinatario recibió el mensaje original, **PrepareSubmit** cambia la propiedad **PR_RECIPIENT_TYPE a MAPI_P1** y establece la propiedad PR_RESPONSIBILITY **en** TRUE y devuelve cualquier error generado por **PrepareSubmit** al cliente.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-114">If the MAPI_SUBMITTED flag is not set, indicating that the recipient did receive the original message, **PrepareSubmit** changes the **PR_RECIPIENT_TYPE** property to MAPI_P1 and sets the **PR_RESPONSIBILITY** property to TRUE and returns any error generated by **PrepareSubmit** to the client.</span></span> 
    
2. <span data-ttu-id="ad6c1-115">Establece el indicador MSGFLAG_SUBMIT en la propiedad del mensaje **PR_MESSAGE_FLAGS**.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-115">Sets the MSGFLAG_SUBMIT flag in the message's **PR_MESSAGE_FLAGS** property.</span></span> 
    
3. <span data-ttu-id="ad6c1-116">Se asegura de que hay una columna para **PR_RESPONSIBILITY** en la tabla de destinatarios y establece en FALSE para indicar que no hay transporte tiene de responsabilidad supuesta a�n para transmitir el mensaje.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-116">Makes sure that there is a column for **PR_RESPONSIBILITY** in the recipient table and sets it to FALSE to indicate that no transport has of yet assumed responsibility for transmitting the message.</span></span> 
    
4. <span data-ttu-id="ad6c1-117">Establece la fecha y la hora de origen en **la PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="ad6c1-117">Sets the date and time of origination in the **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)) property.</span></span>
    
5. <span data-ttu-id="ad6c1-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span><span class="sxs-lookup"><span data-stu-id="ad6c1-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span></span> 
    
   - <span data-ttu-id="ad6c1-119">Expanda todas las listas de distribuci�n personal y destinatarios personalizados y reemplace todos los nombres de presentaci�n que ha cambiado con sus nombres originales.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-119">Expand all personal distribution lists and custom recipients and replace all changed display names with their original names.</span></span>
   - <span data-ttu-id="ad6c1-120">Quite los nombres duplicados.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-120">Remove duplicate names.</span></span>
   - <span data-ttu-id="ad6c1-121">Compruebe si hay preprocesamiento necesario y, si es necesario, establezca la marca NEEDS_PREPROCESSING y la propiedad **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)), una propiedad reservada para MAPI.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-121">Check for any required preprocessing, and if preprocessing is required, set the NEEDS_PREPROCESSING flag and the **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) property, a property reserved for MAPI.</span></span> 
   - <span data-ttu-id="ad6c1-122">Establecer el indicador NEEDS_SPOOLER si el almac�n de mensajes se complementa con un transporte y no puede controlar todos los destinatarios.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-122">Set the NEEDS_SPOOLER flag if the message store is tightly coupled with a transport and it cannot handle all of the recipients.</span></span> 
    
6. <span data-ttu-id="ad6c1-123">Si se establece la marca de mensaje NEEDS_PREPROCESSING, realiza las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="ad6c1-123">Performs the following tasks if the NEEDS_PREPROCESSING message flag is set:</span></span>
    
   - <span data-ttu-id="ad6c1-124">Coloca el mensaje en la cola de salida con SUBMITFLAG_PREPROCESS bit establecido en **la PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="ad6c1-124">Puts the message in the outgoing queue with the SUBMITFLAG_PREPROCESS bit set in the **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) property.</span></span>
   - <span data-ttu-id="ad6c1-125">Notifica a la cola MAPI que ha cambiado la cola.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-125">Notifies the MAPI spooler that the queue has changed.</span></span>
   - <span data-ttu-id="ad6c1-126">Devuelve el control al cliente y contin�a el flujo de mensajes en la cola MAPI.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-126">Returns control to the client, and message flow continues in the MAPI spooler.</span></span> 
   - <span data-ttu-id="ad6c1-127">La cola MAPI realiza las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="ad6c1-127">The MAPI spooler performs the following tasks:</span></span>
     - <span data-ttu-id="ad6c1-128">Bloquea el mensaje llamando a IMsgStore::SetLockState.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-128">Locks the message by calling IMsgStore::SetLockState.</span></span> 
     - <span data-ttu-id="ad6c1-129">Realiza el preprocesamiento necesario llamando a todas las funciones de preprocesamiento en el orden de registro.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-129">Performs the needed preprocessing by calling all of the preprocessing functions in the order of registration.</span></span> <span data-ttu-id="ad6c1-130">Los proveedores de transporte llaman a IMAPISupport::RegisterPreprocessor para registrar funciones de preprocesamiento.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-130">Transport providers call IMAPISupport::RegisterPreprocessor to register preprocessing functions.</span></span> 
     - <span data-ttu-id="ad6c1-131">Llama a IMessage::SubmitMessage en el mensaje abierto para indicar al almacén de mensajes que el preprocesamiento se ha completado.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-131">Calls IMessage::SubmitMessage on the open message to indicate to the message store that preprocessing is complete.</span></span>

<br/>

<span data-ttu-id="ad6c1-132">Los dos pasos siguientes se producen en el proceso de cliente si no hubo preprocesamiento y cuando la cola MAPI llama **a SubmitMessage** si hubo preprocesamiento.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-132">The following two steps occur in the client process if there was no preprocessing, and when the MAPI spooler calls **SubmitMessage** if there was preprocessing.</span></span> 

<span data-ttu-id="ad6c1-133">**El proveedor del almacén de mensajes:**</span><span class="sxs-lookup"><span data-stu-id="ad6c1-133">**The message store provider**:</span></span>

1. <span data-ttu-id="ad6c1-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span><span class="sxs-lookup"><span data-stu-id="ad6c1-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span></span>
    
   - <span data-ttu-id="ad6c1-135">Administra a todos los destinatarios que pueden administrar.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-135">Handles any recipients that it can handle.</span></span>
   - <span data-ttu-id="ad6c1-136">Establece la propiedad **PR_RESPONSIBILITY** en TRUE para todos los destinatarios que administra.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-136">Sets the **PR_RESPONSIBILITY** property to TRUE for any recipients that it handles.</span></span> 
   - <span data-ttu-id="ad6c1-137">Si todos los destinatarios se conocen en este almac�n de acoplamiento ajustado y transporte, realiza las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="ad6c1-137">Performs the following tasks if all recipients are known to this tightly coupled store and transport:</span></span>
     - <span data-ttu-id="ad6c1-138">Llama a IMAPISupport::CompleteMsg si el mensaje se preprocesó o el proveedor del almacén de mensajes desea que la cola MAPI complete el procesamiento de mensajes, lo que se recomienda para que se puedan invocar los enlaces de mensajería.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-138">Calls IMAPISupport::CompleteMsg if the message was preprocessed or the message store provider wants the MAPI spooler to complete message processing which is recommended so that messaging hooks can be invoked.</span></span> <span data-ttu-id="ad6c1-139">El flujo de mensajes continúa con la cola MAPI, tal como se describe en el siguiente procedimiento.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-139">Message flow continues with the MAPI spooler as described in the following procedure.</span></span>  
     - <span data-ttu-id="ad6c1-140">Realiza las siguientes tareas si el mensaje no se preprocesó o si el proveedor del almacén de mensajes no desea que la cola MAPI complete el procesamiento de mensajes:</span><span class="sxs-lookup"><span data-stu-id="ad6c1-140">Performs the following tasks if the message was not preprocessed or the message store provider does not want the MAPI spooler to complete message processing:</span></span>
       - <span data-ttu-id="ad6c1-141">Copia el mensaje en la carpeta identificada por el identificador de entrada en la PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId), si se establece.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-141">Copies the message to the folder identified by the entry identifier in the PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) property, if set.</span></span>
       - <span data-ttu-id="ad6c1-142">Elimina el mensaje si la propiedad PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) se ha establecido en TRUE.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-142">Deletes the message if the PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) property has been set to TRUE.</span></span>
       - <span data-ttu-id="ad6c1-143">Desbloquea el mensaje si está bloqueado.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-143">Unlocks the message if it is locked.</span></span>
       - <span data-ttu-id="ad6c1-144">Devuelve al cliente.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-144">Returns to the client.</span></span> <span data-ttu-id="ad6c1-145">El flujo de mensajes se ha completado.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-145">Message flow is complete.</span></span> 
   
2. <span data-ttu-id="ad6c1-146">Si el almac�n de mensajes no est� estrechamente asociado a un transporte, no todos los destinatarios eran conocidos para el almac�n de mensajes o se establece la marca NEEDS_SPOOLER, realiza las tareas siguientes:</span><span class="sxs-lookup"><span data-stu-id="ad6c1-146">Performs the following tasks if the message store is not tightly coupled to a transport, not all of the recipients were known to the message store, or the NEEDS_SPOOLER flag is set:</span></span>
    
   - <span data-ttu-id="ad6c1-147">Coloca el mensaje en la cola de salida sin establecer el bit SUBMITFLAG_PREPROCESS en la propiedad **PR_SUBMIT_FLAGS**.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-147">Puts the message in the outgoing queue without setting the SUBMITFLAG_PREPROCESS bit in the **PR_SUBMIT_FLAGS** property.</span></span> 
   - <span data-ttu-id="ad6c1-148">Notifica a la cola MAPI que ha cambiado la cola de salida al generar una notificaci�n de la tabla.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-148">Notifies the MAPI spooler that the outgoing queue has changed by generating a table notification.</span></span> 
   - <span data-ttu-id="ad6c1-149">Devuelve al cliente y el flujo de mensajes contin�a con un conjunto de tareas que se realizan por la cola MAPI.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-149">Returns to the client, and message flow continues with a set of tasks performed by the MAPI spooler.</span></span>
    
<span data-ttu-id="ad6c1-p107">Cuando un mensaje gestione la cola MAPI, el proveedor de almacenamiento de mensajes, establece la propiedad del mensaje **PR_SUBMIT_FLAGS** a SUBMITFLAG_LOCKED. El indicador SUBMITFLAG_LOCKED indica que la cola MAPI ha bloqueado el mensaje para su uso exclusivo. El otro valor para **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, se establece cuando el mensaje requiere preprocesamiento por una o m�s funciones del preprocesador registradas por un proveedor de transporte.</span><span class="sxs-lookup"><span data-stu-id="ad6c1-p107">When a message is to be handled by the MAPI spooler, the message store provider sets the message's **PR_SUBMIT_FLAGS** property to SUBMITFLAG_LOCKED. The SUBMITFLAG_LOCKED flag indicates that the MAPI spooler has locked the message for its exclusive use. The other value for **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, is set when the message requires preprocessing by one or more preprocessor functions registered by a transport provider.</span></span> 
  

